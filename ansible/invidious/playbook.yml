- name: Invidious
  hosts: all
  vars:
    app: invidious
    git_dir: '{{ tmp }}/git-repo'
    pat: !vault |
      $ANSIBLE_VAULT;1.1;AES256
      39316663663030663565626465363734353266623565313631663161396563623864316133313537
      3438333633333030663064626235353938346336633837370a656664613965623262356131646137
      33336666333033326361343636333439616139393734343561323864643035626261346631313366
      3666326531363464660a313365636239616363663965636439356533643232323936366433383933
      66366134613130663438383238613939643564616634316162346436346230326234316335626363
      6263646365663034353261646138303865303430666661316662
  tasks:
  - import_tasks: ../shared/docker_login.yml
  - import_tasks: ../shared/prepare_docker_compose_app.yml

  - name: Create temporary directory if not already exists
    ansible.builtin.file:
      path: '{{ tmp }}'
      state: directory

  - name: Checkout temporary files neccessary for Docker container
    ansible.builtin.git:
      repo: https://github.com/johannes-qvarford/invidious.git
      dest: '{{ tmp }}/git-repo'
      version: jq

  - name: Copy neccessary config files to target
    register: app_config
    ansible.builtin.copy:
      src: '{{ git_dir }}/config'
      dest: '{{ target }}/config'
      remote_src: yes

  - name: Copy neccessary docker files to target
    register: app_docker
    ansible.builtin.copy:
      src: '{{ git_dir }}/docker'
      dest: '{{ target }}/docker'
      remote_src: yes

  - name: Determine if app should be reloaded
    ansible.builtin.set_fact:
      restart_app_condition: true
    when: app_config is changed or app_docker is changed

  - import_tasks: ../shared/restart_docker_compose_app.yml