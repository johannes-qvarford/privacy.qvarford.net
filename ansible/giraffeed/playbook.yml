- name: Giraffeed
  hosts: all
  vars:
    app: giraffeed
    target: '{{ apps_directory }}/{{ app }}'
    pat: !vault |
      $ANSIBLE_VAULT;1.1;AES256
      39316663663030663565626465363734353266623565313631663161396563623864316133313537
      3438333633333030663064626235353938346336633837370a656664613965623262356131646137
      33336666333033326361343636333439616139393734343561323864643035626261346631313366
      3666326531363464660a313365636239616363663965636439356533643232323936366433383933
      66366134613130663438383238613939643564616634316162346436346230326234316335626363
      6263646365663034353261646138303865303430666661316662
    
  tasks:
  - name: Create directory if not already exists
    file:
      path: '{{ target }}'
      state: directory

  - name: Copy Docker-Compose file
    ansible.builtin.copy:
      src: docker-compose.yml
      dest: '{{ target }}/'

  - name: Copy NGinx file
    ansible.builtin.copy:
      src: '{{ app }}.conf'
      dest: '{{ nginx_sites_enabled_directory }}/'

  - name: Docker Login
    community.docker.docker_login:
      registry_url: ghcr.io
      username: johannes-qvarford
      password: '{{ pat }}'
      reauthorize: false

  - name: Restart App
    community.docker.docker_compose:
      state: present
      restarted: true
      pull: true
      project_src: '{{ target }}'

  - name: Restart NGinx
    community.docker.docker_compose:
      state: present
      restarted: true
      pull: true
      project_src: '{{ nginx_app_directory }}'