- name: Monica
  hosts: all
  vars:
    app: monica
    app_key: !vault |
      $ANSIBLE_VAULT;1.1;AES256
      39363939633663356663326237326463386561353038663436666139313364653933393638306463
      3334633061643661633265303963616231306134626565340a356531363934626635636233323433
      34343737383866613534666537333733636232373737386133363666613531323163636432636137
      3939343735656262320a303533626464376336636338363835333465623661663631313636623764
      64633831333637323138633263633238323966643765326237623935613935656634383231656363
      30646265343836656137663736393739353465613835663165663363666333656236366564636635
      626336383964326362383161326563643833
    email: !vault |
      $ANSIBLE_VAULT;1.1;AES256
      35383931313036646534356639623861393436343266323230366161333937396235616362653531
      6466303939393365633734376266386430663362373763300a663637626331653066386534623635
      39626162396439336430373639626430623562303637373534343235663732323162313662373937
      6337643232313761380a383364303435643630333161326631363064343433396532653137613035
      65336263373665366135353832393939353932316338373235333236363439303066
    password: !vault |
      $ANSIBLE_VAULT;1.1;AES256
      62383837666131343766376166353035623733663438363762636530343363323533663863393838
      3332303639666662656534646466393237346465303665380a323037373263366566646266313739
      64303262383661323763633531346663363363356539353266353566643138663261306337643432
      6335343039363938660a366237633663653963383739396666626133373665303034613431356638
      32306561313637333739333738376337393366646133333562656561616364613731626564313963
      6330653436313034666366643731333730313539343738306231
  tasks:
  - import_tasks: ../shared/prepare_docker_compose_app.yml

  - name: Replace app key with pre-generated one.
    ansible.builtin.replace:
      path: '{{ target }}/docker-compose.yml'
      regexp: 'APP_KEY_REPLACE_ME'
      replace: '{{ app_key }}'

  - import_tasks: ../shared/restart_docker_compose_app.yml

  - name: Create first account
    command: "docker-compose -f {{ target }}/docker-compose.yml exec app php artisan setup:production --no-interaction --email '{{ email }}' --password '{{ password }}'"

  # Restart again
  - import_tasks: ../shared/restart_docker_compose_app.yml